# Новая упрощенная логика работы с ресурсами

## Принцип работы

**Одна таблица `resources` для всего!**

Вместо двух таблиц (`moderation_submissions` и `resources`) теперь используется одна таблица `resources` со статусами:
- `pending` - заявка на модерации
- `approved` - одобренный ресурс (отображается везде)
- `rejected` - отклоненный ресурс

## Процесс работы

### 1. Создание заявки
**Файл:** `api/resources/submit.js`

Пользователь заполняет форму → создается ресурс в таблице `resources` со статусом `pending`

```sql
INSERT INTO resources (..., status) VALUES (..., 'pending')
```

### 2. Модерация
**Файл:** `api/moderation/index.js`

Админ видит все ресурсы со статусом `pending`:
```sql
SELECT * FROM resources WHERE status = 'pending'
```

При одобрении - просто меняется статус:
```sql
UPDATE resources SET status = 'approved' WHERE id = ...
```

При отклонении - меняется статус на `rejected`:
```sql
UPDATE resources SET status = 'rejected' WHERE id = ...
```

### 3. Отображение
Все запросы фильтруют только ресурсы со статусом `approved`:

**Главная страница:**
```sql
SELECT * FROM resources WHERE status = 'approved' AND category_id = ...
```

**Мои ресурсы:**
```sql
SELECT * FROM resources WHERE author_id = ... AND status = 'approved'
```

**Платные ресурсы:**
```sql
SELECT * FROM resources WHERE status = 'approved' AND is_paid = TRUE
```

## Преимущества новой логики

1. **Простота** - одна таблица вместо двух
2. **Надежность** - нет копирования данных между таблицами
3. **Прозрачность** - все ресурсы в одном месте
4. **Легкость отладки** - можно увидеть все статусы ресурса

## Структура таблицы resources

```sql
CREATE TABLE resources (
  id VARCHAR(255) PRIMARY KEY,
  title VARCHAR(500) NOT NULL,
  description TEXT,
  telegram_link VARCHAR(500),
  telegram_username VARCHAR(255),
  category_id VARCHAR(50) NOT NULL,
  subcategory_id VARCHAR(50),
  cover_image TEXT,
  is_private BOOLEAN DEFAULT FALSE,
  author_id VARCHAR(255) NOT NULL,
  author_username VARCHAR(255),
  status VARCHAR(50) DEFAULT 'pending',  -- NEW!
  is_paid BOOLEAN DEFAULT FALSE,
  paid_until TIMESTAMP,
  moderated_by_id VARCHAR(255),          -- NEW!
  moderated_by VARCHAR(255),             -- NEW!
  moderated_at TIMESTAMP,                -- NEW!
  rejection_reason TEXT,                 -- NEW!
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

## Миграция

При первом запуске система автоматически:
1. Добавит поле `status` в существующую таблицу
2. Установит `status = 'approved'` для всех существующих ресурсов
3. Добавит поля модерации, если их нет

## Что изменилось

### API Endpoints

**Создание заявки:**
- `POST /api/resources/submit` - создает ресурс со статусом `pending`

**Модерация:**
- `GET /api/moderation?action=pending` - получает ресурсы со статусом `pending`
- `POST /api/moderation { action: 'approve', submissionId: '...' }` - меняет статус на `approved`
- `POST /api/moderation { action: 'reject', submissionId: '...' }` - меняет статус на `rejected`

**Отображение:**
- `GET /api/resources?category=...` - только `approved`
- `GET /api/users-me-resources` - только `approved`
- `GET /api/resources/paid` - только `approved`

## Проверка работы

1. Создайте заявку - она должна появиться в модерации со статусом `pending`
2. Одобрите заявку - статус должен измениться на `approved`
3. Проверьте отображение - ресурс должен появиться на главной странице и в "Мои ресурсы"

