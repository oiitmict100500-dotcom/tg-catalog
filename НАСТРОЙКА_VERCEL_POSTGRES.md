# Настройка Vercel Postgres для хранения заявок на модерацию

## Важно: Изменения в Vercel

С июня 2025 года Vercel прекратил поддержку собственной службы Vercel Postgres и перешел на интеграции с внешними поставщиками через Vercel Marketplace. Рекомендуется использовать интеграцию с **Neon**, которая обеспечивает serverless PostgreSQL.

## Пошаговая инструкция

### Шаг 1: Установка интеграции Neon через Vercel Marketplace

1. **Перейдите в Vercel Marketplace:**
   - Откройте https://vercel.com/storage/postgres
   - Или в вашем проекте Vercel перейдите в **Storage** → **Browse Marketplace**

2. **Выберите Neon:**
   - Найдите интеграцию **Neon**
   - Нажмите **Install** или **Add Integration**

3. **Подключите к проекту:**
   - Выберите ваш проект `tg-catalog` (или другое имя)
   - Нажмите **Add**

### Шаг 2: Создание базы данных

1. **Создайте базу данных:**
   - В вашем проекте Vercel перейдите в **Storage**
   - Нажмите **Create Database**
   - Выберите **Neon** (если не выбрано)
   - Выберите регион (ближайший к вашим пользователям)
   - Выберите план:
     - **Free** - для начала (512 MB storage, 0.5 CPU)
     - **Launch** - для продакшена ($19/месяц)
   - Нажмите **Continue**

2. **Назовите базу данных:**
   - Введите имя: `tg-catalog-db` (или любое другое)
   - Нажмите **Create**

### Шаг 3: Подключение базы данных к проекту

1. **Подключите базу данных:**
   - В разделе **Storage** найдите созданную базу данных
   - Нажмите **Connect** или **...** → **Connect**
   - Vercel автоматически добавит переменные окружения

2. **Проверьте переменные окружения:**
   - Перейдите в **Settings** → **Environment Variables**
   - Должна быть переменная `DATABASE_URL` или `POSTGRES_URL`
   - Значение должно начинаться с `postgresql://` или `postgres://`

### Шаг 4: Перезапуск деплоя

1. **Перезапустите деплой:**
   - Перейдите в **Deployments**
   - Найдите последний деплой
   - Нажмите **...** → **Redeploy**
   - Или сделайте новый коммит в GitHub

2. **Проверьте логи:**
   - После деплоя перейдите в **Functions**
   - Откройте `/api/resources/submit`
   - В логах должны быть сообщения:
     - `✅ Connected to PostgreSQL via pg`
     - `✅ PostgreSQL connection verified`
     - `✅ Database tables initialized`

### Шаг 5: Проверка работы

1. **Отправьте тестовую заявку:**
   - Заполните форму добавления ресурса
   - Отправьте на модерацию
   - Проверьте логи в `/api/resources/submit`

2. **Проверьте панель модерации:**
   - Войдите как админ
   - Перейдите в **Модерация заявок**
   - Заявка должна появиться в списке

## Альтернативный вариант: Прямое подключение к Neon

Если интеграция через Marketplace не работает, можно подключиться напрямую:

1. **Создайте проект на Neon:**
   - Перейдите на https://neon.tech
   - Создайте аккаунт (бесплатно)
   - Создайте новый проект
   - Дождитесь создания базы данных

2. **Получите connection string:**
   - В проекте Neon перейдите в **Dashboard**
   - Найдите **Connection string**
   - Скопируйте строку подключения (начинается с `postgresql://`)

3. **Добавьте переменную окружения в Vercel:**
   - Перейдите в ваш проект на Vercel
   - **Settings** → **Environment Variables**
   - Добавьте переменную:
     - **Name:** `DATABASE_URL`
     - **Value:** вставьте скопированную строку подключения
   - Нажмите **Save**

4. **Перезапустите деплой**

## Устранение проблем

### Ошибка: "No database connection string found"
- Проверьте, что переменная `DATABASE_URL` или `POSTGRES_URL` установлена в Vercel
- Убедитесь, что переменная добавлена для нужного окружения (Production, Preview, Development)
- Перезапустите деплой после добавления переменной

### Ошибка: "Connection refused" или "ECONNREFUSED"
- Проверьте, что строка подключения правильная
- Для Neon проверьте, что IP не заблокирован (обычно разрешены все IP)
- Проверьте, что база данных создана и активна

### Ошибка: "relation 'moderation_submissions' does not exist"
- Таблица должна создаваться автоматически при первом запросе
- Проверьте логи в Vercel Functions
- Если таблица не создается, проверьте права пользователя базы данных
- Попробуйте отправить заявку еще раз

### Заявки не появляются в панели модерации
- Проверьте логи в `/api/moderation/pending`
- Убедитесь, что заявки сохраняются в базу данных (логи в `/api/resources/submit`)
- Проверьте, что статус заявки = 'pending'
- Проверьте, что вы вошли как админ

## Структура таблицы

Таблица `moderation_submissions` создается автоматически со следующими полями:

- `id` - уникальный идентификатор заявки (VARCHAR(255), PRIMARY KEY)
- `title` - название ресурса (VARCHAR(500), NOT NULL)
- `description` - описание (TEXT)
- `telegram_link` - ссылка на Telegram (VARCHAR(500))
- `telegram_username` - username ресурса (VARCHAR(255))
- `category_id` - ID категории (VARCHAR(50), NOT NULL)
- `subcategory_id` - ID подкатегории (VARCHAR(50), NOT NULL)
- `cover_image` - обложка в Base64 (TEXT, NOT NULL)
- `is_private` - приватный ресурс (BOOLEAN, DEFAULT FALSE)
- `author_id` - ID автора (VARCHAR(255), NOT NULL)
- `author_username` - username автора (VARCHAR(255), NOT NULL)
- `status` - статус ('pending', 'approved', 'rejected') (VARCHAR(50), DEFAULT 'pending')
- `created_at` - дата создания (TIMESTAMP, DEFAULT CURRENT_TIMESTAMP)
- `moderated_by_id` - ID модератора (VARCHAR(255))
- `moderated_by` - username модератора (VARCHAR(255))
- `moderated_at` - дата модерации (TIMESTAMP)
- `rejection_reason` - причина отклонения (TEXT)

Индексы:
- `idx_status` - на поле `status`
- `idx_created_at` - на поле `created_at`
- `idx_author_id` - на поле `author_id`

## Преимущества PostgreSQL

✅ **Надежность** - данные сохраняются навсегда  
✅ **Масштабируемость** - работает с любым количеством заявок  
✅ **Совместимость** - работает на всех инстансах Vercel  
✅ **Производительность** - быстрые запросы с индексами  
✅ **Безопасность** - транзакции и ACID гарантии

## Следующие шаги

После настройки PostgreSQL:
1. Все заявки будут сохраняться в базу данных
2. Заявки будут доступны на всех инстансах Vercel
3. Данные не будут теряться при перезапуске функций
4. Можно добавить дополнительные функции (поиск, фильтрация, пагинация)

