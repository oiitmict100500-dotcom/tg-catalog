# Итоговая логика работы с ресурсами

## Простая структура: одна таблица `resources` со статусами

### Таблица resources
Все ресурсы хранятся в одной таблице `resources` с полем `status`:
- `pending` - заявка на модерации
- `approved` - одобренный ресурс (отображается везде)
- `rejected` - отклоненный ресурс

## Процесс работы

### 1. Пользователь создает заявку
**Файл:** `api/resources/submit.js`
**Endpoint:** `POST /api/resources/submit`

- Пользователь заполняет форму "Добавить ресурс"
- Создается запись в таблице `resources` со статусом `pending`
- ID генерируется как `resource-{timestamp}-{random}`

```sql
INSERT INTO resources (..., status) VALUES (..., 'pending')
```

### 2. Админ проверяет заявки
**Файл:** `api/moderation/index.js`
**Endpoint:** `GET /api/moderation?action=pending`

- Показываются все ресурсы со статусом `pending`
- Админ видит все заявки, ожидающие модерации

```sql
SELECT * FROM resources WHERE status = 'pending'
```

### 3. Админ одобряет заявку
**Файл:** `api/moderation/index.js`
**Endpoint:** `POST /api/moderation { action: 'approve', submissionId: '...' }`

- Меняется статус ресурса с `pending` на `approved`
- Ресурс теперь будет отображаться везде

```sql
UPDATE resources SET status = 'approved' WHERE id = ...
```

### 4. Ресурс отображается везде

#### 4.1. Главная страница (по категориям)
**Файл:** `api/resources/index.js`
**Endpoint:** `GET /api/resources?category={categoryId}`

- Показываются только ресурсы со статусом `approved`
- Фильтруются по выбранной категории

```sql
SELECT * FROM resources 
WHERE category_id = $1 AND status = 'approved'
ORDER BY is_paid DESC, created_at DESC
```

#### 4.2. Мои ресурсы
**Файл:** `api/users-me-resources.js`
**Endpoint:** `GET /api/users-me-resources`

- Показываются только ресурсы текущего пользователя со статусом `approved`
- Фильтруются по `author_id` текущего пользователя

```sql
SELECT * FROM resources 
WHERE author_id = $1 AND status = 'approved'
ORDER BY created_at DESC
```

#### 4.3. Платные ресурсы
**Файл:** `api/resources/paid.js`
**Endpoint:** `GET /api/resources/paid`

- Показываются только платные ресурсы со статусом `approved`

```sql
SELECT * FROM resources 
WHERE status = 'approved' AND is_paid = TRUE
```

## Что происходит при одобрении

1. Админ нажимает "Одобрить" в панели модерации
2. Вызывается `updateResourceStatus(resourceId, 'approved', moderatorInfo)`
3. Выполняется SQL: `UPDATE resources SET status = 'approved' WHERE id = ...`
4. Ресурс теперь имеет статус `approved`
5. При загрузке главной страницы - ресурс появляется в выбранной категории
6. При загрузке "Мои ресурсы" - ресурс появляется у автора

## Ключевые моменты

✅ **Одна таблица** - все ресурсы в `resources`
✅ **Статусы** - `pending`, `approved`, `rejected`
✅ **Фильтрация** - все запросы фильтруют по `status = 'approved'`
✅ **Простота** - нет копирования данных, просто изменение статуса

## Логирование

Добавлено подробное логирование на всех этапах:
- При создании ресурса
- При одобрении (изменении статуса)
- При загрузке ресурсов
- При запросах к БД

Все логи можно увидеть в панели Vercel.

