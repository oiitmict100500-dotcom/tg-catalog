# Настройка PostgreSQL для хранения заявок на модерацию

## Проблема
В Vercel Serverless Functions каждый вызов может выполняться на разных инстансах, поэтому in-memory хранилище не работает. Нужна база данных PostgreSQL.

## Варианты настройки

### Вариант 1: Vercel Postgres (Рекомендуется)

1. **Создайте базу данных в Vercel:**
   - Перейдите в ваш проект на Vercel
   - Откройте вкладку **Storage**
   - Нажмите **Create Database** → выберите **Postgres**
   - Выберите план (Hobby - бесплатный для начала)
   - Нажмите **Create**

2. **Добавьте переменную окружения:**
   - Перейдите в **Settings** → **Environment Variables**
   - Vercel автоматически добавит переменную `POSTGRES_URL`
   - Проверьте, что она есть в списке

3. **Перезапустите деплой:**
   - Перейдите в **Deployments**
   - Нажмите на последний деплой → **Redeploy**

### Вариант 2: Supabase (Бесплатный)

1. **Создайте проект на Supabase:**
   - Перейдите на https://supabase.com
   - Создайте аккаунт (бесплатно)
   - Создайте новый проект
   - Дождитесь создания базы данных

2. **Получите connection string:**
   - В проекте Supabase перейдите в **Settings** → **Database**
   - Найдите **Connection string** → **URI**
   - Скопируйте строку подключения (начинается с `postgresql://`)

3. **Добавьте переменную окружения в Vercel:**
   - Перейдите в ваш проект на Vercel
   - **Settings** → **Environment Variables**
   - Добавьте переменную:
     - **Name:** `DATABASE_URL`
     - **Value:** вставьте скопированную строку подключения
   - Нажмите **Save**

4. **Перезапустите деплой**

### Вариант 3: Neon (Бесплатный)

1. **Создайте проект на Neon:**
   - Перейдите на https://neon.tech
   - Создайте аккаунт (бесплатно)
   - Создайте новый проект
   - Дождитесь создания базы данных

2. **Получите connection string:**
   - В проекте Neon перейдите в **Dashboard**
   - Найдите **Connection string**
   - Скопируйте строку подключения

3. **Добавьте переменную окружения в Vercel:**
   - Перейдите в ваш проект на Vercel
   - **Settings** → **Environment Variables**
   - Добавьте переменную:
     - **Name:** `DATABASE_URL`
     - **Value:** вставьте скопированную строку подключения
   - Нажмите **Save**

4. **Перезапустите деплой**

### Вариант 4: Свой PostgreSQL сервер

1. **Настройте PostgreSQL сервер:**
   - Установите PostgreSQL на вашем сервере
   - Создайте базу данных
   - Создайте пользователя с правами доступа

2. **Добавьте переменную окружения в Vercel:**
   - **Name:** `DATABASE_URL`
   - **Value:** `postgresql://username:password@host:port/database`
   - Если требуется SSL, добавьте `?sslmode=require`

3. **Перезапустите деплой**

## Проверка работы

После настройки базы данных:

1. **Отправьте тестовую заявку:**
   - Заполните форму добавления ресурса
   - Отправьте на модерацию

2. **Проверьте логи в Vercel:**
   - Перейдите в **Functions** → `/api/resources/submit`
   - Должны быть логи: `✅ Connected to PostgreSQL`
   - Должны быть логи: `✅ Submission saved to PostgreSQL`

3. **Проверьте панель модерации:**
   - Войдите как админ
   - Перейдите в **Модерация заявок**
   - Заявка должна появиться в списке

## Устранение проблем

### Ошибка: "No database connection string found"
- Проверьте, что переменная окружения `POSTGRES_URL` или `DATABASE_URL` установлена в Vercel
- Убедитесь, что переменная добавлена для нужного окружения (Production, Preview, Development)

### Ошибка: "Connection refused" или "ECONNREFUSED"
- Проверьте, что строка подключения правильная
- Для внешних баз данных проверьте, что сервер доступен из интернета
- Для Supabase/Neon проверьте, что IP не заблокирован (обычно разрешены все IP)

### Ошибка: "relation 'moderation_submissions' does not exist"
- Таблица должна создаваться автоматически при первом запросе
- Проверьте логи в Vercel Functions
- Если таблица не создается, проверьте права пользователя базы данных

### Заявки не появляются в панели модерации
- Проверьте логи в `/api/moderation/pending`
- Убедитесь, что заявки сохраняются в базу данных
- Проверьте, что статус заявки = 'pending'

## Структура таблицы

Таблица `moderation_submissions` создается автоматически со следующими полями:

- `id` - уникальный идентификатор заявки
- `title` - название ресурса
- `description` - описание
- `telegram_link` - ссылка на Telegram
- `telegram_username` - username ресурса
- `category_id` - ID категории
- `subcategory_id` - ID подкатегории
- `cover_image` - обложка (Base64)
- `is_private` - приватный ресурс
- `author_id` - ID автора
- `author_username` - username автора
- `status` - статус ('pending', 'approved', 'rejected')
- `created_at` - дата создания
- `moderated_by_id` - ID модератора
- `moderated_by` - username модератора
- `moderated_at` - дата модерации
- `rejection_reason` - причина отклонения

## Миграция данных

Если у вас уже есть заявки в старом хранилище (in-memory), они не будут автоматически перенесены в PostgreSQL. Нужно будет отправить их заново или создать скрипт миграции.

